{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<main class="content">

    {% include 'includes/navigation.html' %}

    <div class="py-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
                <li class="breadcrumb-item"><a href="#"><span class="fas fa-home"></span></a></li>
                <li class="breadcrumb-item active" aria-current="page">Facebook User Profile From Group FB</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between w-100 flex-wrap">
            <div class="mb-3 mb-lg-0">
                <h1 class="h4">Facebook User Profile From Group FB</h1>
            </div>
        </div>
    </div>
    <div class="card border-light shadow-sm mb-4">
        <div class="card-body">
            <div class="row" id="check-facebook">
                <div>
                    <button id="trigger-button" onclick="crawlFacebookUserProfile()" class="btn btn-lg btn-secondary" type="button">Quét Dữ Liệu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-light shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="data" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Số Thứ Tự</th>
                            <th>User ID</th>
                            <th>User Name</th>
                            <th>Post ID</th>
                            <th>Group ID</th>
                            <th>Tên</th>
                            <th>Công việc</th>
                            <th>Giáo dục</th>
                            <th>Số bạn bè</th>
                            <th>Số Follower</th>
                            <th>Số Following</th>
                            <th>Ảnh nền</th>
                            <th>Ảnh đại diện</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th></th>
                            <th>Số Thứ Tự</th>
                            <th>User ID</th>
                            <th>User Name</th>
                            <th>Post ID</th>
                            <th>Group ID</th>
                            <th>Tên</th>
                            <th>Công việc</th>
                            <th>Giáo dục</th>
                            <th>Số bạn bè</th>
                            <th>Số Follower</th>
                            <th>Số Following</th>
                            <th>Ảnh nền</th>
                            <th>Ảnh đại diện</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {% include 'includes/footer.html' %}

</main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

{% csrf_token %}
<script type="text/javascript">
    currentTimestamp = parseInt(moment().unix());
    theInterval = null;

    function deleteDatatableRecords() {
        id_array = [];

        $(".odd").each(function (index) {
            if ($(this).find("input[type=checkbox]").is(":checked")) {
                id_array.push($(this).find("td")[1].innerHTML);
            }
        });

        $(".even").each(function (index) {
            if ($(this).find("input[type=checkbox]").is(":checked")) {
                id_array.push($(this).find("td")[1].innerHTML);
            }
        });

        $.ajax({
            type: 'POST',
            url: '/facebook-user-profile-job-delete-data/',
            data: {
                "id_array": id_array.join(','),
            },
            success: function (response) {

                const notyf = new Notyf({
                    position: {
                        x: 'right',
                        y: 'top',
                    },
                    ripple: true,
                    types: [
                        {
                            type: 'success',
                            background: '#1b998b',
                            icon: {
                                className: '',
                                tagName: 'span',
                                color: '#fff'
                            },
                            dismissible: true,
                        }
                    ]
                });

                notyf.open({
                    type: 'success',
                    message: 'Đã xóa thành công !!!'
                });

                $('#data').DataTable().clear().draw();
            },
            error: (xhr) => {
                const notyf = new Notyf({
                    position: {
                        x: 'right',
                        y: 'top',
                    },
                    ripple: true,
                    types: [
                        {
                            type: 'error',
                            background: '#FA5151',
                            icon: {
                                className: '',
                                tagName: 'span',
                                color: '#fff'
                            },
                            dismissible: true,
                        }
                    ]
                });

                notyf.open({
                    type: 'error',
                    message: 'Xóa thất bại hoặc bạn chưa chọn dữ liệu để xóa !!!'
                });

            },
        });
    }

    function refreshDatatable() {
        $('.table-responsive').toggle();
    }

    function changeToClientSide() {
        $('#data').DataTable().destroy();
        $('#data').DataTable({
            serverSide: false,
            searching: false,
            paging: false,
            destroy: true,
            bSort: false,
            dom: 'Bfrtip',
            buttons: [
                'copyHtml5',
                'excelHtml5',
                'csvHtml5',
                'pdfHtml5',
                {
                    text: "Tắt Tự Động Cập Nhật",
                    className: 'btn-danger',
                    action: function (e, dt, node, config) {
                        clearInterval(theInterval);
                        $('#data').DataTable().destroy();
                        changeToServerSide();
                    },
                },
            ]
        });
        $('#data').DataTable().clear().draw();

        setTimeout(function () {
            $('.dt-buttons button').removeClass('dt-button').addClass('btn btn-sm');
            $('.buttons-copy').addClass('btn btn-sm btn-info');
            $('.buttons-excel').addClass('btn btn-sm btn-tertiary');
            $('.buttons-csv').addClass('btn btn-sm btn-success');
            $('.buttons-pdf').addClass('btn btn-sm btn-primary');
        }, 100);

        theInterval = setInterval(function () {

            $.ajax({
                type: 'POST',
                url: '/facebook-user-profile-auto-data/',
                data: {
                    "timestamp": parseInt(currentTimestamp)
                },
                success: function (response) {
                    $('#data').DataTable().clear().draw();
                    const notyf = new Notyf({
                        position: {
                            x: 'right',
                            y: 'top',
                        },
                        ripple: true,
                        types: [
                            {
                                type: 'success',
                                background: '#1b998b',
                                icon: {
                                    className: '',
                                    tagName: 'span',
                                    color: '#fff'
                                },
                                dismissible: true,
                            }
                        ]
                    });

                    for (i = 0; i < response.data.length; i++) {
                        $('#data').dataTable().fnAddData([
                            '',
                            response.data[i]["id"],
                            response.data[i]["user_id_job"],
                            response.data[i]["user_name_job"],
                            response.data[i]["post_id"],
                            response.data[i]["group_id"],
                            response.data[i]["name"],
                            response.data[i]["work"],
                            response.data[i]["education"],
                            response.data[i]["friend_count"],
                            response.data[i]["follower_count"],
                            response.data[i]["following_count"],
                            response.data[i]["cover_photo"],
                            response.data[i]["profile_picture"],
                        ]);
                    }
                    
                    $('#data').DataTable().order([1, 'asc']).draw();
                    $('#data').DataTable().order([0, 'asc']).draw();
                },
                error: (xhr) => {
                    const notyf = new Notyf({
                        position: {
                            x: 'right',
                            y: 'top',
                        },
                        ripple: true,
                        types: [
                            {
                                type: 'error',
                                background: '#FA5151',
                                icon: {
                                    className: '',
                                    tagName: 'span',
                                    color: '#fff'
                                },
                                dismissible: true,
                            }
                        ]
                    });

                    notyf.open({
                        type: 'error',
                        message: 'Kết nối thất bại !!!'
                    });

                },
            });

        }, 5000);

    }

    function changeToServerSide() {
        $('#data').DataTable({
            serverSide: true,
            destroy: true,
            order: [[5, "desc"]],
            search: {
                search: " "
            },
            sAjaxSource: "/facebook-user-profile-job-show-data/",  // new url
            columnDefs: [
                {
                    targets: 0,
                    width: 100,
                    checkboxes: {
                        selectRow: true
                    }
                }
            ],
            columns: [
                { name: "checkbox", data: 0 },
                { name: "id", data: 0 },
                { name: "user_id_job", data: 1 },
                { name: "user_name_job", data: 2 },
                { name: "post_id", data: 3 },
                { name: "group_id", data: 4 },
                { name: "name", data: 5 },
                { name: "work", data: 6 },
                { name: "education", data: 7 },
                { name: "friend_count", data: 8 },
                { name: "follower_count", data: 9 },
                { name: "following_count", data: 10 },
                { name: "cover_photo", data: 11 },
                { name: "profile_picture", data: 12 }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    text: "Cập Nhật",
                    className: 'btn-primary',
                    action: function (e, dt, node, config) {
                        refreshDatatable();
                        dt.ajax.reload(null, true);
                        setTimeout(function () {
                            refreshDatatable()
                        }, 100);
                    },
                },
                'copyHtml5',
                'excelHtml5',
                'csvHtml5',
                'pdfHtml5',
                {
                    text: "Tự Động Cập Nhật",
                    className: 'btn-warning',
                    action: function (e, dt, node, config) {
                        changeToClientSide();
                    },
                },
                {
                    text: "Xóa Dữ Liệu Đã Chọn",
                    className: 'btn btn-danger',
                    action: function (e, dt, node, config) {
                        if (window.confirm("Bạn có chắn chắn muốn xóa?")) {
                            deleteDatatableRecords();
                        }
                    },
                },
            ]
        });

        setTimeout(function () {
            $('.dt-buttons button').removeClass('dt-button').addClass('btn btn-sm');
            $('.buttons-copy').addClass('btn btn-sm btn-info');
            $('.buttons-excel').addClass('btn btn-sm btn-tertiary');
            $('.buttons-csv').addClass('btn btn-sm btn-success');
            $('.buttons-pdf').addClass('btn btn-sm btn-danger');
        }, 100);

    }

    $(document).ready(function () {
        changeToServerSide()
    });

    function crawlFacebookUserProfile() {
        $("#trigger-button").attr("disabled", true);
            $("#trigger-button").html('<i class="fas fa-sync fa-spin"></i>');
            $.ajax({
                type: 'POST',
                url: '/facebook-user-profile-job-get-data/',
                data: {},
                success: function (response) {
                    const notyf = new Notyf({
                        position: {
                            x: 'right',
                            y: 'top',
                        },
                        ripple: true,
                        types: [
                            {
                                type: 'success',
                                background: '#1b998b',
                                icon: {
                                    className: '',
                                    tagName: 'span',
                                    color: '#fff'
                                },
                                dismissible: true,
                            }
                        ]
                    });
                    notyf.open({
                        type: 'success',
                        message: 'Đã gửi lệnh quét thành công. Xin tải lại bảng dữ liệu hoặc bật chế độ thời gian thực để kiểm tra dữ liệu đang được quét'
                    });

                    setTimeout(function () {
                        $("#trigger-button").attr("disabled", false);
                        $("#trigger-button").html('Quét Dữ Liệu');
                    }, 5000);

                },
                error: (xhr) => {
                    const notyf = new Notyf({
                        position: {
                            x: 'right',
                            y: 'top',
                        },
                        ripple: true,
                        types: [
                            {
                                type: 'error',
                                background: '#FA5151',
                                icon: {
                                    className: '',
                                    tagName: 'span',
                                    color: '#fff'
                                },
                                dismissible: true,
                            }
                        ]
                    });
                    notyf.open({
                        type: 'error',
                        message: 'Lỗi ' + String(xhr.statusText) + ':' + String(xhr.responseJSON) + '<br><br>Xin vui lòng thử lại hoặc liên hệ với bên kĩ thuật'
                    });
                    $("#trigger-button").attr("disabled", false);
                    $("#trigger-button").html('Quét Dữ Liệu');
                },
            });
    }

</script>

{% endblock javascripts %}